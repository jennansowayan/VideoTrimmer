<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Trimming App</title>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">

    <style>
        #frameImage {
            cursor: crosshair;
            border: 1px solid #000;
            position: relative;
            z-index: 1;
            /* Ensure the image is below the ROI selector */
        }

        .rectangle {
            border: 2px dashed #FF0000;
            position: absolute;
            z-index: 2;
            /* Ensure the ROI selector is above the image */
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        {% with messages = get_flashed_messages() %}
        {% if messages %}
        <div class="alert alert-danger">
            {% for message in messages %}
            <p>{{ message }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        <h1 class="text-center">Upload Video for Trimming</h1>
        <form action="{{ url_for('upload_video') }}" method="post" enctype="multipart/form-data" class="mt-4">
            <div class="form-group">
                <label for="file">Video File:</label>
                <input type="file" class="form-control-file" name="file" id="file" required>
            </div>
            <button type="submit" class="btn btn-primary btn-block">Upload</button>
        </form>

        {% if video_uploaded %}
        <h2 class="text-center mt-5">Select ROI</h2>
        <div class="">
            <img id="frameImage" src="{{ first_frame_path }}" alt="First Frame">
            <div id="rectangle" class="rectangle" style="display:none;"></div>
        </div>
        <form action="{{ url_for('process_video') }}" method="post" class="mt-4">
            <input type="hidden" name="video_path" value="{{ video_path }}">
            <div class="form-group">
                <label for="x">X:</label>
                <input type="number" class="form-control" name="x" id="x" required>
            </div>
            <div class="form-group">
                <label for="y">Y:</label>
                <input type="number" class="form-control" name="y" id="y" required>
            </div>
            <div class="form-group">
                <label for="w">Width (W):</label>
                <input type="number" class="form-control" name="w" id="w" required>
            </div>
            <div class="form-group">
                <label for="h">Height (H):</label>
                <input type="number" class="form-control" name="h" id="h" required>
            </div>
            <button type="button" id="getDimensions" class="btn btn-success btn-block">Get Dimensions</button>
            <button type="submit" class="btn btn-primary btn-block mt-2">Process Video</button>
        </form>
        {% endif %}

        {% if clips %}
        <h2 class="text-center mt-5">Trimmed Clips</h2>
        <button class="btn btn-success mb-3" onclick="window.location.href='{{ url_for('download_all') }}'">Download All
            Clips</button>
        <table id="clipsTable" class="display">
            <thead>
                <tr>
                    <th>Clip Name</th>
                    <th>Duration</th>
                    <th>Download</th>
                </tr>
            </thead>
            <tbody>
                {% for clip in clips %}
                <tr>
                    <td>{{ clip.name }}</td>
                    <td>{{ clip.duration }}</td>
                    <td><a href="{{ url_for('download_file', filename=clip.name) }}"
                            class="btn btn-primary">Download</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% endif %}
    </div>
    <script async src="https://docs.opencv.org/4.x/opencv.js"></script>

    <script>
        $(document).ready(function () {
            var img = document.getElementById('frameImage');
            var rect = document.getElementById('rectangle');
            var x = $('#x');
            var y = $('#y');
            var w = $('#w');
            var h = $('#h');
            var startX, startY, endX, endY;
            var isDrawing = false;

            img.addEventListener('mousedown', function (event) {
                var rectBounds = img.getBoundingClientRect();
                startX = event.clientX - rectBounds.left;
                startY = event.clientY - rectBounds.top;
                isDrawing = true;
                console.log("top: " + rectBounds.top + ", left: " + rectBounds.left);
                console.log("clientX: " + event.clientX + ", clientY: " + event.clientY);
                console.log("startX: " + startX + ", startY: " + startY);


                rect.style.left = startX + 'px';
                rect.style.top = startY + 'px';
                rect.style.width = 0;
                rect.style.height = 0;
                rect.style.display = 'block';
            });

            img.addEventListener('mousemove', function (event) {
                if (isDrawing) {
                    var rectBounds = img.getBoundingClientRect();
                    endX = event.clientX - rectBounds.left;
                    endY = event.clientY - rectBounds.top;

                    console.log("clientX: " + event.clientX + ", clientY: " + event.clientY);
                    console.log("endX: " + endX + ", endY: " + endY);

                    var width = endX - startX;
                    var height = endY - startY;

                    // Handle negative width and height
                    if (width < 0) {
                        rect.style.left = (startX + width) + 'px';
                        rect.style.width = Math.abs(width) + 'px';
                    } else {
                        rect.style.width = width + 'px';
                    }

                    if (height < 0) {
                        rect.style.top = (startY + height) + 'px';
                        rect.style.height = Math.abs(height) + 'px';
                    } else {
                        rect.style.height = height + 'px';
                    }
                }
            });

            img.addEventListener('mouseup', function (event) {
                if (isDrawing) {
                    isDrawing = false;
                    rect.style.display = 'none';
                    var rectBounds = rect.getBoundingClientRect();
                    var imgBounds = img.getBoundingClientRect();

                    // Calculate the correct coordinates relative to the image
                    x.val(Math.round(rectBounds.left));
                    y.val(Math.round(rectBounds.top + imgBounds.top));
                    w.val(Math.round(rectBounds.width));
                    h.val(Math.round(rectBounds.height));
                }
            });

            // Prevent the image from being dragged (if needed)
            img.addEventListener('dragstart', function (event) {
                event.preventDefault();
            });
        });
    </script>



</body>

</html>